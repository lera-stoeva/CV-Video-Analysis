# README #

Стоева Валерия Эдуардовна

Группа 156
Проект:
«Анализ видеопоследовательностей для автоматического поиска и выделения рекламы»

Задача 1: Поиск в видео рекламы из базы рекламы. 

В папке «base_video» лежат видео файлы с рекламой, в папке «base_descr» текстовые файлы с дескрипторами этой же рекламы (файлы в папках имеют одно название, но разные форматы: mp4 и  txt, а в папке «main_video» лежит наше основное видео в формате mp4, из которого нам надо вырезать рекламу и текстовый файл с таким же названием, как и само видео. Текстовый файл получен после обработки видео библиотекой STIP, и в нем хранятся координаты и дескрипторы всех интересных точек на видео

ПОСТРОЕНИЕ БАЗЫ
Для начала работы нам надо запустить файл «построение базы.py». Программа откроет папку «main_video» и возьмет из нее наше видео и текстовый файл с описанием интересных точек. На основе текстового файла и с помощью функции built_model из new_func будет построена модель. То есть все точки из видео будут кластеризованы, а так же мы сможем получить частоту кластеров (то есть узнать как часто встречаются точки одного кластера по отношению к точкам из других кластеров). 
Замечание: Для готового продукта модель должна быть построена не на основе видео из которого надо удалять рекламу, а на основе большой базы разных видеопотоков, для того что бы не строить модель заново для каждого видео, которое надо обработать. Можно будет один раз сформировать модель и один раз сформировать базу рекламы. К сожалению, я не смогла собрать большое количество видео для формирования настоящей модели, но модель из одного обрабатываемого видео работает хорошо. 

Далее программа откроет папку «base_descr», посмотрит на все текстовые файлы, которые там лежат (это файлы с интересными точками каждого видео из базы рекламы) и построит базу на основе этих файлов. Сначала все интересные точки из файлов будут описаны в терминах модели, то есть кластеризованы максимально похоже на модель с помощью функции labels = model.predict(features).astype(int). На выходе программа получит словарь, где каждому названию рекламы будет сопоставлена последовательность типов точек. 

После того, как мы сформировали модель и базу, записываем полученные данные в текстовые файлы «model.txt» и «base_descriptor.txt».

Функция new_func.stip_analysis кластеризует дискрипторы в терминах модели и тем самым превратит наш текстовый файл с его дескрипторами точек основного видео
в словарь, сопоставляющий каждой координате (X, Y, T) -  тип точки, которая появляется в этом месте на видео. Однако после работы этой функции на одном кадре могут остаться 2-3 интересные точки и даже больше. 

Функция new_func.video_to_unique_sequence посмотрит на все интересные точки на одном кадре и оставит только самую уникальную. (Уникальность определяется самой маленькой частотой появления на видео) 

Мы превратили основное видео и набор рекламы у последовательности из цифр (номера кластеров, они же типы точек). Теперь осталось посмотреть входит ли маленькая последовательность в большую. Мы просто идем по последовательностям, описывающим каждую рекламу и проверяем ее вхождение в последовательность, описывающую основаное видео. Если последовательность из базы рекламы найдена в последовательности основного видео то мы смотрим на название рекламы. В папке «base_video» лежат видео с такими же названиями, что и текстовые описания. Так что мы можем легко зайти в эту папку и посмотреть на длину видео с тем же названием, что лежит в словаре base. Если время найденой подпоследовательности не сильно отличается от времени рекламы, значит мы все таки нашли рекламу и можем вырезать её из видео. 

Функция new_func.cut_the_fragment осуществляет визуализацию удаления рекламы из видео. 
Сначала части видео без рекламы записываются в папку «fragments_without_ad», а затем эти фрагменты объединяются в одно видео ready_to_watch.mp4

Задача 2: Поиск повторяющегося видеопотока в одном потоке. 

Для того чтобы удалять рекламу из базы, её сначала надо сформировать. Процесс нахождения рекламы можно автоматизировать. Если в видео определенный набор кадров повторяется 2-3 раза, то, скорее всего, это реклама. Значит, мы можем снова перевести наше видео в последовательность точек и найти в ней повторяющуюся подпоследовательность, проверить то, как долго по времени она длится и определить реклама это или нет. 

ПОИСК ПОВТОРОВ
В файле «поиск повторов.py» мы так же загружаем основное видео и его STIP обработку из папки «main_video» (В моем примере папка «main_video2» для хорошей визуализации второй задачи). 
Так же строим модель на основе видео и с помощью функций new_func.stip_analysis и new_func.video_to_unique_sequence получаем 2 списка: координаты времени и тип точки, которая появляется в это время. (На каждом кадре лежит одна самая уникальная точка, так что проблем с последовательностью не возникает)

С помощью алгоритма new_func.search_repetitions мы можем найти повторяющиеся последовательности и записать координаты их начала и конца. 

Получаем интервалы начала и конца нашей последовательности и снова проверяем их на длительность по времени. Если найденая последовательность длится 20-30 секунд, то она может быть рекламой. Реклама обычно не длится 5 секунд или минуту. 

Мы получили интервалы последовательностей, которые могут быть рекламой, но многие из них пересекаются. Тогда мы разбиваем все интервалы на группы, в каждую группы попадут интервалы, пересекающиеся между собой. 
Пересечение всех интервалов одной группы будем считать рекламой, которую надо достать из основного видео и сохранить в базу. 

Функция new_func.extract_reklama осуществляем визуализацию. Здесь все намного проще, просто берем видео и время начала и конца интервала, вырезаем нашу рекламу и отправляем в папку «For_the_base». Таким образом, в нашей папке появляются 2-3 почти одинаковых видео, в зависимости от количества повторов рекламного ролика в основном видеопотоке. 

Инструкция по компиляции:
Необходимо установить библиотеки OpenCV2 и STIP,  Ffmpeg

Заключение:
Поиск повторяющегося видеопотока в одном потоке записывает в результат первые секунда перед или после рекламы. Это связанно с работой библиотеки STIP. При обработке были выставлены параметры так, чтобы алгоритм работы библиотеки находил только самые важные точки. В связи с этим STIP может пропускать несколько секунд из видео. То есть в текстовом файле дескрипторов, может не оказаться точек с первых секунд начала рекламы или конца. Но алгоритм search_repetitions находит точки, ближайшие к временному интервалу рекламы. 


